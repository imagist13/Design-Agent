### Refly.AI 产品架构概览

Refly.AI 的整体架构围绕「Vibe Workflow + Intervenable Agent」展开，可抽象为四层：**体验层、编排层、智能层、基础设施层**，外加一条贯穿全局的 **观测与市场生态通道**。

---

### 1. 体验层（Experience Layer）

- **1.1 画布编辑器（Vibe Canvas）**
  - 自由画布 + 节点/连线交互，用于构建和编辑工作流。
  - 提供节点拖拽、连接、分组、注释等功能，支持复杂流程的视觉化表达。
  - 与 Copilot 深度集成，可根据自然语言指令在画布上自动生成/修改流程。

- **1.2 Workflow Copilot 交互界面**
  - 聊天式输入区，用户用自然语言描述业务目标和期望流程。
  - Copilot 给出「流程草稿 + 修改建议」，并可解释每个节点的作用。

- **1.3 运行控制与调试面板**
  - 运行/暂停/停止控制按钮。
  - 节点级执行日志、输入输出快照、错误信息展示。
  - 支持在运行中插入人工干预步骤（修改参数、重新选择分支等）。

- **1.4 Workflow App 前台界面**
  - 将工作流封装为对外提供给终端用户的简单应用界面。
  - 支持参数表单、运行按钮、结果展示等基础 UI 组件。

---

### 2. 编排层（Orchestration Layer）

- **2.1 Workflow 模型与元数据**
  - 使用统一的工作流描述模型（Graph/DSL），包含：
    - 节点类型（Agent、工具调用、条件判断、子流程等）；
    - 节点输入输出参数定义；
    - 节点间依赖关系与数据流；
    - 运行策略（并行/串行、重试策略、超时等）。
  - 支持工作流版本管理和快照（便于回滚和对比）。

- **2.2 Workflow 引擎**
  - 负责解析工作流模型，调度各节点按拓扑顺序或策略执行。
  - 支持：
    - 异步执行与并发控制；
    - 条件分支与循环；
    - 子流程调用与复用。
  - 与 Agent 引擎协作，将高阶 Agent 节点的执行过程拆分为更细粒度的步骤。

- **2.3 状态管理与检查点（Checkpointing）**
  - 为每个工作流实例维护运行状态：
    - 当前执行到的节点；
    - 每个节点输入输出快照；
    - 中间缓存与上下文。
  - 提供检查点机制，支持：
    - 失败后从中间节点恢复；
    - 用户回滚到任一历史步骤重新执行；
    - 记录干预操作，便于复盘和学习。

---

### 3. 智能层（Intelligence Layer）

- **3.1 Agent 引擎**
  - 提供统一的 Agent 抽象：
    - 能力配置（检索、规划、工具调用等）；
    - Prompt 模板与角色设定；
    - 使用的模型与参数（温度、最大 token 等）。
  - 负责单个 Agent 的「规划 → 调用模型 → 工具调用 → 结果整理」全流程。

- **3.2 Vibe Workflow Planner（意念流规划器）**
  - 将用户的自然语言需求解析为：
    - 任务拆解（多步骤）；
    - 步骤间依赖关系；
    - 建议的 Agent 类型与节点配置。
  - 输出结构化的工作流草图，由编排层负责落盘与执行。

- **3.3 上下文与记忆系统**
  - 会话级上下文：当前构建的工作流、需求变更记录。
  - 用户/团队级记忆：常用模板、历史工作流、偏好设置。
  - 任务级知识：绑定的知识库、文档集合、数据源等，为 Agent 提供检索上下文。

- **3.4 工具与集成适配层**
  - 提供统一的 Tool 接口定义，支持：
    - HTTP API 调用；
    - 第三方 SaaS（如 Slack、飞书、Notion 等）；
    - 数据库/向量库查询；
    - 内部服务调用（企业版）。
  - Agent 引擎通过工具适配层完成读写外部世界、执行业务动作。

---

### 4. 数据与知识层（Data & Knowledge Layer）

- **4.1 用户数据与配置存储**
  - 用户账号、团队空间、权限与角色配置。
  - 工作流定义、版本、运行历史记录。

- **4.2 内容与知识库**
  - 用户上传的文档、笔记、网页快照等结构化/半结构化内容。
  - 支持向量化索引，为 Agent 提供检索增强（RAG）能力。

- **4.3 运行日志与观测数据**
  - 节点执行时间、失败率、重试次数等运行指标。
  - LLM 调用统计（token 用量、延迟）。
  - 为后续调优、限流与计费提供基础数据。

---

### 5. 基础设施与部署（Infra & Deployment）

- **5.1 服务化拆分**
  - Web 前端：画布、控制台、Workflow App 界面。
  - 后端 API 网关：统一对外接口、鉴权、限流。
  - 工作流与 Agent 服务：负责调度、状态管理、模型/工具调用。
  - 向量与存储服务：知识库、日志与配置存储。

- **5.2 多种部署形态**
  - **Refly Cloud 公有云服务**：面向个人与中小团队。
  - **自托管社区版**：通过开源仓库部署在用户自有环境。
  - **企业私有化部署**：支持与企业内部系统、私有模型/数据的深度集成。

- **5.3 伸缩与弹性**
  - 异步任务队列 + Worker 架构，用于大规模工作流并发执行。
  - 模型调用层可对接多家大模型服务商或本地部署模型，支持路由与熔断。

---

### 6. Workflow Marketplace 与生态层

- **6.1 Workflow 模板与市场**
  - 将工作流定义、参数描述、使用说明等打包成 Marketplace 资产。
  - 支持一键复制、安装、二次编辑，降低使用门槛。

- **6.2 收费与分成机制**
  - 对工作流运行次数、调用量或订阅进行计费。
  - 平台与创作者按规则分成，形成可持续的创作者生态。

- **6.3 观测与推荐**
  - 基于运行数据和用户反馈评估模板质量。
  - 向用户推荐高质量/高转化率的工作流模板，促进生态循环。

---

### 7. 小结

Refly.AI 的架构本质上是：在传统工作流编排与 Agent 框架之上，叠加了一层面向非技术用户的「自然语言 + 画布」体验，以及一条面向创作者的「市场与变现」通道。编排层保证可控与稳定，智能层提供灵活与强大，生态层则负责长期增长与用户粘性。

